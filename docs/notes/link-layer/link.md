# 链路层与局域网 笔记

## 概述

链路层协议是解决网络中两个相邻节点到节点的底层应用，链路层的连接有两种方式，一种是点到点的方式，实现起来比较简单，比如跨洋的线路就是点到点的方式，带宽大延迟大，双向通道各走各的。另外一种是多点连接方式，一般是局域网使用，连接节点非常方便，连接在共享性介质上（交换机），多点连接的方式要点到点方式来的复杂，需要协调多个节点对信道的访问和使用。

主机和路由器都是节点，节点的连接有有线和无线的方式，链路层协议数据单元称为帧，封装网络层的数据报。 不同的链路层协议传送数据报的方式也有所不同，第一跳可能是以太网，中间跳是中间续链路，最后一跳是802.11（无线）。数据报封装在帧中，加上帧头和帧尾，如果采用的是共享性介质（交换机），信道连接获取访问权限。在帧头使用 MAC （物理）地址来标识源和目标。在链路层中部分是有可靠数据传输的，比如无线传输是，因为无线本身是不可能信道出差率高，所以要可靠数据传输来确认数据的传输成功，如果把可靠数据传输丢给上层协议代价会更大。有线传输就不需要可靠数据传输，因为本身信道就是可靠的，传输出差的几率很低。如果增加了可靠数传输势必会加重负担，得不偿失。

链路层的实现是在每个主机或者路由器的“适配器”（网卡）上，网卡上实现了链路层和相应物理层的功能，硬件、软件和固件的综合体。

## 差错检测和纠正

链路层也提供的最基本的错误检测，通过校验和来知道就收到的数据是否在传输的过程中发送了错误。

链路层用的校验和方式是 CRC （循环冗余校验）

1. 模 2 运算（异或）
2. 位串的两种表现形式 1011 = 1*x^3 + 0*x^2 + 1*x + 1*x^0 = x^3 + x + 1

3. 生成多项式，r 的次方 G = x^3 + 1 , r + 1

4. 约定，发送方求出 EDC（r位），发送 D 和 EDC 给接收方，接收方拿到后能整除 G （生成多项式）

![Image text](./image/1645605792(1).png)

![Image text](./image/1645605855(1).png)

## 多点访问协议

多路访问协议（介质访问控制协议：MAC），该协议主要是针对多点连接，局域网的的协议，多个节点连接在同一个交换机上如何来协调节点访问信道，如果两个节点同时传送势必会冲突。多路访问协议是分布式算法-决定节点共享信道，关于共享控制的通信必须用借助信道本身传输！没有带外的信道，各节点使用其协调信道使用，用于传输控制信息。

### MAC （介质访问控制）协议的分类

3 大类：
  * 信道划分：
    * 把信道划分成小片（时间、频率、编码）
    * 分配片给每个节点专用
  * 随机访问
    * 信道不划分，允许冲突
    * 冲突后恢复
  * 依次轮流
    * 节点依次轮流
    * 但是有很多数据传输的节点可以获得较长的信道使用权

#### 信道划分

信道划分 MAC 协议分为：TDMA、FDMA、CDMA

TDMA：按时隙分配，轮流使用信道，信道的时间分为周期，每个站点使用每个周期中的固定时隙（长度=帧传输时间）传输帧，如果站点无传输帧，时隙空间浪费。

FDMA：按频段分配，信道的有效频率范围被分成一个个小的频段，每个站点被分配一个固定的频段，分配给站点的频段如果没有被使用，则空闲

CDMA：码分，所有站点在整个频段上同时进行传输, 采用编码原理加以区分

#### 随机 MAC 协议

随机的 MAC 协议有分为一下几种：
1. 时隙ALOHA
2. ALOHA
3. CSMA, **CSMA/CD**,**CSMA/CA**

##### 时隙 ALOHA

如果所有的帧都是等长的，把时间划分成相等的时隙，每个时隙可以发送一帧，所以节点只在时隙开始时发送，节点的发送在时间是哪个是同步的，如果两个节点发生了冲突所以其他节点也都可以检测到。如果节点要发送新的帧在下个时隙开始时，信道是空闲的，没检查冲突，表示传输是成功的。如果在下个时隙传输有冲突，通过 P 概率重新发送，也就是互相抛个色子正面就发反面就不发，0 发送 1 不发送 ，每次都有二分之一的概率可以发送出去。

优点：
* 节点可以以信道带宽全速连续传输
* 高度分布：仅需要节点之间在时隙上的同步
* 简单

缺点：
* 存在冲突，浪费时隙，很可能都是抛的反面
* 即使有帧要发送，仍然有可能存在空闲的时隙
* 节点检测冲突的时间<帧传输的时间 （就算检测到冲突，帧也要传完，浪费时隙）
* 需要所以节点时间上同步

##### 纯 ALOHA

如果和时隙 ALOHA 相比 纯 ALOHA 来的更简单粗暴，无时隙ALOHA：简单、无须节点间在时间上同步，当有帧需要传输：马上传输，因此冲突的概率增加。

* 帧在 t0 发送，和其它在[t0-1, t0+1]区间内开始发送的帧冲突
* 和当前帧冲突的区间（其他帧在此区间开始传输）增大了一倍

那有没有比较好的方法来解决这个大概率冲突了，下面要介绍的 CSMA （载波侦听多路访问）可以解决

##### CSMA（载波侦听多路访问）

在纯 ALOHA 的基础上，在传输帧前先侦听信道，如果帧听到的信道是空闲的就传输这个帧，如果侦听到的信道是忙的就推迟。 
CSMA 也不能完全解决所以情况的冲突，因为传播是有延迟的，比如 A 节点发送了帧，在发送的最开始 B 节点是侦听不到的，只用 A 节点发送的帧到达了 B 节点的脚下，B 节点才能察觉到。可以 B 节点完全有可以能在 A 节点最开始发送时也发送了帧，这样就会产生冲突。传播延迟（距离）决定了冲突的概率

##### CSMA/CD (载波侦听多路访问/冲突检测)

在 CSMA 的基础上有加入冲突检测的机制，也就是我不光光在传输前先侦听下信道，我还在传输时检测冲突，如果有冲突了就终止传输，以此避免浪费信道资源。有线局域网中用到的冲突检测是 CD 。检测信号强度，比较传输与接收到的信号是否相同，通过周期的过零点检测。这样大大减少了信道的浪费。

有线局域网（以太网）中 CSMA/CD 协议的算法

1. 适配器获取数据报，创建帧
2. 发送前：侦听信道CS 1)闲：开始传送帧 2)忙：一直等到闲再发送
3. 发送过程中，冲突检测CD 1)没有冲突:成功 2)检测到冲突:放弃,之后尝试重发
4. 发送方适配器检测到冲突，除放弃外，还发送一个Jam信号，所有听到冲突的适配器也是如此 **强化冲突：让所有站点都知道冲突**
5. 如果放弃，适配器进入指数退避状态在第m次失败后，适配器随机选择一个{0，1，2， ， 2^m-1}中K，等待K*512位时，然后转到步骤2

指数退避算法：每一次连续冲突的累加，就相应扩大随机选择窗口，这样同时选中一个数的几率就变小，发送成功的几率就变大，不过延迟的时间也变大了。最后到10^m 次方就结束算法。

1. 首次碰撞：在{0，1}选择K；延迟K*512位时
2. 第2次碰撞：在{0，1，2，3}选择K
3. 第10次碰撞：在{0，1，2，3，……，1023}选择K

##### CSMA/CA (载波侦听多路访问/预先避免冲突)

下面介绍的是无线局域网中的 CSMA/CA 协议，无线和有线有很大的差异，所以协议也有所不同。无线不能像有线那样传输时检测冲突，所以无线是没冲突检测机制的，因为一般无线发送帧后，离它最近的帧就是它自己发送的帧，所以就算检测到冲突就不代表发送时成功的。同样的在发送帧前侦听信道是否空闲（CMSA）。为了避免无CD带来的信道利用率低的问题，事前进行冲突避免

发送方：
1. 如果站点侦测到信道空闲持续DIFS长，则传输整个帧 (no CD)
2. 如果侦测到信道忙碌，那么 选择一个随机回退值，并在信道空闲时递减该值；如果信道忙碌，回退值不会变化到数到0时（只生在信道闲时）发送整个帧如果没有收到ACK, 增加回退值，重复2

接收方：
1. 如果帧正确，则在SIFS后发送ACK

无线局域网 CA 做的是发送前避免冲突，而不是像 CD 那样在传输时做冲突检测，也就是在发送前各个有帧需要发送的节点选择一个随机数，数值回退到 0  的时候才发送，不同的随机值，肯定只有一个节点会胜利，失败节点会冻结计数器，当胜利节点发完再发。就算这种情况也无法完全避免冲突：

* 比如两个站点相互隐藏，A,B 相互隐藏，C在传输， A,B选择了随机回退值，一个节点如A胜利了，发送，而B节点收不到，顺利count down到0 发送，A,B的发送在C附近
形成了干扰

* 选择了非常靠近的随机回退值， A,B选择的值非常近，A到0后发送，但是这个信号还没到达B时，B也到0了，发送，冲突

#### 轮流 MAC 协议

轮流 MAC 协议有以上两大类协议的优点。

1. 通过轮询，有一个主节点，通过不断的询问其他的节点是否有数据帧要发送。缺点就是轮询的开销也只占用信道的，每个节点必须等待主节点轮询完了才能发送，单点故障，如果主节点宕机了，整个系统就无法工作了。

2. 令牌传递: 控制令牌( token)循环从一个节点到下一个节点传递，令牌到谁哪里就该谁发送了。缺点：令牌开销本身消耗带宽，延迟只有等到抓住令牌，才可传输

#### 小结

多点接入的方式会带共享性介质谁该先有访问信道的权限的问题，如何来协调信道共享和访问，需要借助与**多点访问协议**来协调。以上我介绍了三大类的多点访问协议的方式。目前在以太网（有线局域网）主要使用的是 CSMA/CD。无线局域网使用的是 CSMA/CA。

## LANS（局域网）

### MAC 地址与 ARP 协议

#### MAC 地址

在网络层是 32 bit IP地址，通过 IP 地址实现在互联网中源端到目标端的数据报传输。而在链路层节点到节点帧从一个网卡传递到其他物理连接的另外一个网卡（同一个物理网络中），需要 48 bit MAC 地址，该地址固化在适配器的 ROM 中，有是也可以通过软件设定。理论上全球任何两个网卡的 MAC 地址都是不相同的。

网络地址和mac地址分离：
1. IP地址和MAC地址的作用不同
* IP地址是分层的 
  * 一个子网所有站点网络号一致，路由聚集，减少路由表
  * 需要一个网络中的站点地址网络号一致，如果捆绑需要定制网卡非常麻烦
  * 希望网络层地址是配置的；IP地址完成网络到网络的交付
* mac地址是一个平面的 
  * 网卡在生产时不知道被用于哪个网络，因此给网卡一个唯一的标示，用于区分一个网络内部不同的网卡即可
  * 可以完成一个物理网络内部的节点到节点的数据交付

好处：
1. 分离好处
* 网卡坏了，ip不变，可以捆绑到另外一个网卡的mac上
* 物理网络还可以除IP之外支持其他网络层协议，链路协议为任意 上层网络协议， 如IPX等
2. 捆绑的问题
* 如果仅仅使用IP地址，不用mac地址，那么它仅支持IP协议
* 每次上电都要重新写入网卡 IP地址；
* 另外一个选择就是不使用任何地址；不用MAC地址，则每到来一个帧都要上传到IP层次，由它判断是不是需要接受，干扰一次

MAC地址可以类比为身份证号，基本不会修改，固定的。

IP 地址可以类比为通地址，随时可能搬家，地址改变。

制造商购入MAC地址空间（保证唯一性）

如果我现在购买一个路由器，通电，网卡插上线路，放在我深圳出租屋的网络环境可以用。过年回家放在老家网络中也可以使用，MAC 地址放在任意网络中都可以使用。

#### ARP 协议

通俗点讲，ARP 协议是通过 IP 地址来查找局域网中该 IP 地址的 MAC 地址，因为我不能只知道下一跳的 IP 地址，因为网络层的传输数依赖链路层的，链路层的帧传输是必须要知道下一跳节点的 MAC 地址。ARP 协议主要是通过广播的方式发送出 ARP 的查询包询问局域网中其他节点，其他节点收到查询包后会回复自己的 MAC 地址给对方。获取回应的 MAC 地址后会会缓存到 ARP 表中，形成一个 IP 地址对应 MAC 地址的表现。直到信息超时才删除。

### 以太网（有线局域网）

以太网目前最主流的局域网技术，占有率 98% ，且非常廉价 30块钱搭建可搭建 100 Mbps 带宽。也是最早广泛应用的的局域网技术。带宽可以不断提升。

#### 以太网的物理拓扑:

1. 最早是总线方式连接所有节点，就像一串蚂蚱在一个绳子上，在上个世纪 90 年代比较流行。缺点是所有节点在一个碰撞域内，一次只允许一个节点发送，并且可靠性差，如果介质破损，发送节点会误认为世纪冲突。

2. 星型方式：比如 hub、switch 现在一般是交换机在中心,每个节点以及相连的交换机端口使用（独立的）以太网协议（不会和其他节点的发送产生碰撞）

#### 以太网的帧

![Image text](./image/1645623095(1).png)

以太帧结构：
1. 地址：6字节源MAC地址，目标MAC地址
  * 如：帧目标地址=本站MAC地址，或是广播地址，接收，递交帧中的数据到网络层
  * 否则，适配器忽略该帧
2. 类型：指出高层协议(大多情况下是IP，但也支持其它网络层协议Novell IPX和AppleTalk)
3. CRC：在接收方校验
  * 如果没有通过校验，丢弃错误帧

以太网是无连接不可以靠的传输方式，以太网的MAC协议：采用二进制退避的 CSMA/CD 介质访问控制形式

### WLAN （无线局域网）

#### IEEE 802.11 无线局域网标准

1. 802.11b
  * 使用无需许可的2.4-5 GHz 频谱，无绳电话和微波炉
  * 最高11 Mbps
  * 在物理层采用直接序列扩频 direct sequence spread spectrum (DSSS)，所有的主机采用同样的序列码
2. 802.11a
  * 更高频率5-6 GHz
  * 最高54 Mbps
  * 距离相对短，受多路径影响大
3. 802.11g
  * 频率2.4-5 GHz
  * 最大54 Mbps
  * 与802.11b向后兼容
4. 802.11n: 多天线MIMO
  * 频率2.4-5 GHz
  * 最高200 Mbps

#### WLAN 体系结构

无线主机（手机）与 基站通信，基站 base station = 接入点 access point (AP)。

802.11b: 2.4GHz-2.485GHz 频谱被分为11个相互不同的但是部分重叠的频段
  * AP管理员为AP选择一个频率
  * 可能的干扰: 邻居AP可能选择同样一个信道!

主机: 必须在通信之前和AP建立associate 
* 扫描所有的信道，侦听包含AP SSID和MAC地址的信标帧
  * 主动扫描：主机发送探测，接受AP的响应
  * 被动扫描 
* 选择希望关联的AP 
* 可能需要执行鉴别（认证）[Chapter 8]
  * 基于MAC、用户名口令
  * 通过AP的中继，使用RADIUS鉴别服务器进行身份鉴别 
* 将会执行DHCP获得IP地址和AP所在的子网前缀

### 中间设备

* Hub：集线器

 网段(LAN segments) ：可以允许一个站点发送的网络范围  在一个碰撞域，同时只允许一个站点在发送  如果有2个节点同时发送，则会碰撞  通常拥有相同的前缀，比IP子网更详细的前缀
 所有以hub连到一起的站点处在一个网段，处在一个碰撞域  骨干hub将所有网段连到了一起
 通过hub可扩展节点之间的最大距离
 通过HUB,不能将10BaseT和100BaseT的网络连接到一起

* 交换机

 链路层设备：扮演主动角色（端口执行以太网协议）
 对帧进行存储和转发
 对于到来的帧，检查帧头，根据目标MAC地址进行选择性
转发
 当帧需要向某个（些）网段进行转发，需要使用
CSMA/CD进行接入控制
 通常一个交换机端口一个独立网段
 透明：主机对交换机的存在可以不关心  通过交换机相联的各节点好像这些站点是直接相联的一样  有MAC地址；无IP地址
 即插即用，自学习：
 交换机无需配置